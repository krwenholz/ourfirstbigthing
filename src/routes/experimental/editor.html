<svelte:head>
  <title>Editor</title>
</svelte:head>

<section class='editor'>

  <article>
    <h2>Edit your story</h2>
    <textarea class="story-editor" rows="30" bind:value="storyText"></textarea>
    <button class="loader" on:click="load()">Load</button>
  </article>

  <aside>
    <h2>Preview</h2>
    <details on:toggle="draw(story)">
      <button class="loader" on:click="load()">Draw</button>
      <svg class="visual-story"></svg>
    </details>
    <details>
      <summary>Experience your story</summary>
      <Adventure
        {storyNode}
        {story}
        title="A gentle introduction"
      />
    </details>

  </aside>
</section>

<style>

  .editor {
    display: flex;
  }

  .story-editor {
    min-height: 80vh;
    width: 100ch;
    margin-right: 40px;
  }

  aside {
    width: 100%;
  }

  .visual-story {
    width: 100%;
    min-height: 60vh;
    border: solid;
  }

  .editor :global(.adventure) {
    min-height: 70vh;
  }

  .loader {
    max-width: 10rem;
    display: block;
    padding: 10px;
    margin: 10px;
    cursor: pointer;
    font-size: 14px;
  }

  /* Need a nasty global here because it's unused until later and we don't want svelte
     stripping it*/
  :global(svg.visual-story .link) {
    stroke: #999;
    stroke-opacity: .6;
    stroke-width: 1px;
  }

  summary {
    cursor: pointer;
  }
</style>

<script>
  import exampleStory from '../example-story/exampleStory.js';
  import yaml from 'js-yaml';
  import { draw, validateStoryNode } from '../../lib/story_graphs.js';

  let simulation;

  export default {
    preload({ query: { storyNode }}) {
      return { story: exampleStory, storyText: yaml.safeDump(exampleStory), storyNode};
    },
    methods: {
      redirect(page) {
        window.location = page;
      },
      load() {
        let uncheckedStory;
        try {
          uncheckedStory = yaml.safeLoad(this.get().storyText)
          uncheckedStory["start"] = uncheckedStory["start"] || null;
          for(const nodeKey in uncheckedStory) {
            validateStoryNode(nodeKey, uncheckedStory[nodeKey]);
          }
        } catch(error) {
          alert(error);
          return;
        }

        // TODO(kyle): Pretty sure I need to reload the Adventure component or sumting
        this.set({ story: uncheckedStory });
        this.draw(this.get().story);
      },
      draw(story) {
        if(!document.querySelector("details.visual").open) return;

        if(simulation) simulation.stop();
        simulation = draw(story, "svg.visual-story");
      },
      validate() {
        console.log(this.get().storyText);
      }
    },
    components: {
      Adventure: '../../components/Adventure.html',
    },
  }
</script>
