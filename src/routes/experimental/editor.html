<svelte:head>
  <title>Editor</title>
</svelte:head>

<section class='editor'>

  <article>
    <h2>Story Editor</h2>
    <textarea class='story-editor' rows="30"></textarea>
  </article>

  <aside>
    <h2>Preview</h2>
    <details>
      <summary>Experience your story</summary>
      <Adventure
        {storyNode}
        {story}
        title="A gentle introduction"
      />
    </details>

    <details>
      <summary>Visualize your story</summary>
      <button class="loader" on:click="load()">Draw</button>

      <svg class="visual-story"></svg>
    </details>

  </aside>
</section>

<style>

  .editor {
    display: flex;
  }

  .story-editor {
    min-height: 80vh;
    width: 100ch;
    margin-right: 40px;
  }

  aside {
    width: 100%;
  }

  .visual-story {
    width: 100%;
    min-height: 60vh;
    border: solid;
  }

  .editor :global(.adventure) {
    min-height: 70vh;
  }

  .loader {
    max-width: 10rem;
    display: block;
    padding: 10px;
    margin: 10px;
    cursor: pointer;
    font-size: 14px;
  }

  /* Need a nasty global here because it's unused until later and we don't want svelte
     stripping it*/
  :global(svg.visual_story .link) {
    stroke: #999;
    stroke-opacity: .6;
    stroke-width: 1px;
  }

  summary {
    cursor: pointer;
  }
</style>

<script>
  import yaml from 'js-yaml';
  import { draw } from '../../lib/story_graphs.js';
  import exampleStory from '../example-story/exampleStory.js';

  let simulation;

  export default {
    preload({ query: { storyNode }}) {
      return { story: exampleStory, storyNode};
    },
    methods: {
      load() {
        const data = document.querySelector(".story-editor").value;
        if(simulation) simulation.stop();
        simulation = draw(yaml.safeLoad(data), "svg.visual-story");
      },
      redirect(page) {
        window.location = page;
      },
    },
    components: {
      Adventure: '../../components/Adventure.html',
    },
    async oncreate() {
      const story = document.querySelector(".story-editor");
      story.value = yaml.safeDump(exampleStory);
    },
  }
</script>
