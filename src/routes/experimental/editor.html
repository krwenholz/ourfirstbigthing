<svelte:head>
  <title>Editor</title>
</svelte:head>

<details open="true">
  <summary>Write your story</summary>
  <textarea class="story-editor" rows="30" bind:value="storyText"></textarea>

  <button class="loader" on:click="load()">Load</button>
</details>

<details class="visual" on:toggle="draw(story)">
  <summary>Visualize your story</summary>
  <svg class="visual-story"></svg>
</details>

<details>
  <summary>Experience your story</summary>
  <section class="story-experience">
    <Adventure
      {storyNode}
      {story}
      title="A gentle introduction"
    />
  </section>
</details>

<script>
  import exampleStory from '../example-story/exampleStory.js';
  import yaml from 'js-yaml';
  import { draw, validateStoryNode } from '../../lib/story_graphs.js';

  let simulation;

  export default {
    preload({ query: { storyNode }}) {
      return { story: exampleStory, storyText: yaml.safeDump(exampleStory), storyNode};
    },
    methods: {
      redirect(page) {
        window.location = page;
      },
      load() {
        let uncheckedStory;
        try {
          uncheckedStory = yaml.safeLoad(this.get().storyText)
          uncheckedStory["start"] = uncheckedStory["start"] || null;
          for(const nodeKey in uncheckedStory) {
            validateStoryNode(nodeKey, uncheckedStory[nodeKey]);
          }
        } catch(error) {
          alert(error);
          return;
        }

        // TODO(kyle): Pretty sure I need to reload the Adventure component or sumting
        this.set({ story: uncheckedStory });
        this.draw(this.get().story);
      },
      draw(story) {
        if(!document.querySelector("details.visual").open) return;

        if(simulation) simulation.stop();
        simulation = draw(story, "svg.visual-story");
      },
      validate() {
        console.log(this.get().storyText);
      }
    },
    components: {
      Adventure: '../../components/Adventure.html',
    },
  }
</script>

<style>
  .story-editor {
    width: 100ch;
  }

  .visual-story {
    height: 600px;
    width: 960px;
    border: solid;
  }

  .loader {
    max-width: 10rem;
    display: block;
    padding: 10px;
    margin: 10px;
    cursor: pointer;
    font-size: 14px;
  }

  /* Need a nasty global here because it's unused until later and we don't want svelte
     stripping it*/
  :global(svg.visual-story .link) {
    stroke: #999;
    stroke-opacity: .6;
    stroke-width: 1px;
  }

  .story-experience {
    display: flex;
    flex: 1 0 auto;
  }

  summary {
    cursor: pointer;
  }
</style>
